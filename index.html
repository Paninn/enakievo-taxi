<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–∞–∫—Å–∏ –ï–Ω–∞–∫–∏–µ–≤–æ üöï</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        :root {
            --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass: rgba(255, 255, 255, 0.1);
            --glass-hover: rgba(255, 255, 255, 0.2);
            --accent: #4ecdc4;
            --danger: #ff6b6b;
            --success: #51cf66;
            --shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', system-ui, sans-serif;
            background: var(--primary);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container { max-width: 420px; margin: 0 auto; padding: 20px; }

        .header {
            text-align: center; padding: 30px 0;
            animation: slideDown 0.8s ease-out;
        }
        h1 { font-size: 36px; margin-bottom: 10px; font-weight: 700; }

        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(25px);
            border-radius: 24px;
            padding: 28px;
            margin: 20px 0;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: var(--shadow);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeInUp 0.6s ease-out;
        }

        .glass-card:hover { 
            transform: translateY(-4px);
            box-shadow: 0 30px 60px rgba(0,0,0,0.15);
            background: var(--glass-hover);
        }

        .profile-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 20px 0;
        }
        .profile-item { text-align: center; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 16px; }

        input {
            width: 100%; padding: 20px 24px; margin: 12px 0;
            background: rgba(255,255,255,0.15);
            border: 2px solid transparent;
            border-radius: 20px;
            font-size: 18px;
            color: white;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        input::placeholder { color: rgba(255,255,255,0.7); }
        input:focus {
            outline: none;
            border-color: var(--accent);
            background: rgba(255,255,255,0.2);
            transform: scale(1.02);
        }
        input.error { border-color: var(--danger); background: rgba(255,107,107,0.2); }

        .btn {
            width: 100%; padding: 22px; margin: 16px 0;
            border: none; border-radius: 20px;
            font-size: 20px; font-weight: 600;
            cursor: pointer; transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        .btn-primary { background: linear-gradient(135deg, var(--accent), #45b7a3); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 15px 30px rgba(78,205,196,0.4); }
        .btn-secondary { background: rgba(255,255,255,0.15); color: white; }
        
        #priceCard { font-size: 28px; font-weight: 700; text-align: center; min-height: 80px; display: flex; align-items: center; justify-content: center; }

        .orders-list {
            max-height: 300px; overflow-y: auto;
            display: grid; gap: 12px;
        }
        .order-item {
            background: rgba(255,255,255,0.08);
            padding: 16px; border-radius: 16px;
            border-left: 4px solid var(--accent);
        }
        .order-time { font-size: 14px; opacity: 0.8; }
        .order-route { font-size: 18px; font-weight: 600; margin: 4px 0; }
        .order-price { font-size: 20px; color: var(--success); font-weight: 700; }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-30px); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöï –¢–∞–∫—Å–∏ –ï–Ω–∞–∫–∏–µ–≤–æ</h1>
            <p style="opacity: 0.9;">–ë—ã—Å—Ç—Ä–æ ‚Ä¢ –î—ë—à–µ–≤–æ ‚Ä¢ –ù–∞–¥—ë–∂–Ω–æ</p>
        </div>

        <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
        <div class="glass-card" id="profileCard">
            <div class="profile-grid">
                <div class="profile-item">
                    <div style="font-size: 24px; margin-bottom: 8px;">üë§</div>
                    <div id="userName" style="font-weight: 600;"></div>
                </div>
                <div class="profile-item">
                    <div style="font-size: 24px; margin-bottom: 8px;">üÜî</div>
                    <div id="userId" style="font-family: monospace; font-size: 14px;"></div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <div style="font-size: 18px; opacity: 0.9;">–ó–∞–∫–∞–∑–æ–≤: <span id="ordersCount">0</span></div>
            </div>
        </div>

        <!-- –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ -->
        <div class="glass-card">
            <h3 style="margin-bottom: 20px;">üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã</h3>
            <div class="orders-list" id="ordersList">
                <div style="text-align: center; opacity: 0.6; padding: 40px;">
                    –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å
                </div>
            </div>
        </div>

        <!-- –§–æ—Ä–º–∞ –∑–∞–∫–∞–∑–∞ -->
        <div class="glass-card">
            <h3 style="margin-bottom: 20px;">üìç –ù–æ–≤—ã–π –∑–∞–∫–∞–∑</h3>
            
            <input type="text" id="from" placeholder="–û—Ç–∫—É–¥–∞: —É–ª. –õ–µ–Ω–∏–Ω–∞, –¶–µ–Ω—Ç—Ä, –†—ã–Ω–æ–∫...">
            <input type="text" id="to" placeholder="–ö—É–¥–∞: —É–ª. –°–æ–≤–µ—Ç—Å–∫–∞—è, –î–æ–Ω–µ—Ü–∫, –ó—É–≥—Ä—ç—Å...">
            <input type="tel" id="phone" placeholder="üì± +7 (XXX) XXX-XX-XX">
            <input type="text" id="comment" placeholder="–ü–∞—Å—Å–∞–∂–∏—Ä–æ–≤ 2 / –ë–∞–≥–∞–∂ / –î–µ—Ç—Å–∫–æ–µ –∫—Ä–µ—Å–ª–æ">

            <div id="priceCard" class="glass-card" style="margin: 20px 0; font-size: 24px;">
                –í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å–∞ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞
            </div>

            <button class="btn btn-primary" onclick="calculatePrice()" id="calcBtn">üí∞ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ü–µ–Ω—É</button>
            <button class="btn btn-primary" onclick="sendOrder()" id="orderBtn" style="display: none;">‚úÖ –ó–∞–∫–∞–∑–∞—Ç—å —Ç–∞–∫—Å–∏</button>
        </div>
    </div>

    <script>
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        Telegram.WebApp.MainButton.setText("üöÄ –ó–∞–∫–∞–∑–∞—Ç—å").setParams({color: '#4ecdc4'}).hide().onClick(sendOrder);

        const user = Telegram.WebApp.initDataUnsafe.user;
        const orders = JSON.parse(localStorage.getItem('orders') || '[]');

        // –ë–∞–∑–∞ –∞–¥—Ä–µ—Å–æ–≤ –ï–Ω–∞–∫–∏–µ–≤–æ (—Ä–µ–∞–ª—å–Ω—ã–µ —É–ª–∏—Ü—ã/—Ä–∞–π–æ–Ω—ã)
        const ENAKIEVO_ADDRESSES = {
            streets: ['–õ–µ–Ω–∏–Ω–∞', '–°–æ–≤–µ—Ç—Å–∫–∞—è', '–ú–∏—Ä–∞', '–û–∫—Ç—è–±—Ä—å—Å–∫–∞—è', '–ö–∏—Ä–æ–≤–∞', '–ì–∞–≥–∞—Ä–∏–Ω–∞', '–ü—É—à–∫–∏–Ω–∞', '–®–µ–≤—á–µ–Ω–∫–æ'],
            districts: ['–¶–µ–Ω—Ç—Ä', '–°–µ–≤–µ—Ä–Ω—ã–π', '–Æ–∂–Ω—ã–π', '–ó–∞–ø–∞–¥–Ω—ã–π', '–í–æ—Å—Ç–æ—á–Ω—ã–π', '–†—ã–Ω–æ–∫', '–®–∫–æ–ª–∞ ‚Ññ1', '–®–∫–æ–ª–∞ ‚Ññ5'],
            nearby: ['–ó—É–≥—Ä—ç—Å', '–®–∞—Ö—Ç—ë—Ä—Å–∫', '–•–∞—Ä—Ü—ã–∑—Å–∫', '–î–æ–Ω–µ—Ü–∫', '–ú–∞–∫–µ–µ–≤–∫–∞']
        };

        // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
        document.getElementById('userName').textContent = user.first_name + (user.last_name ? ' ' + user.last_name : '');
        document.getElementById('userId').textContent = user.id;
        document.getElementById('ordersCount').textContent = orders.length;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
        showOrders();

        function validateAddress(address) {
            const cleanAddr = address.toLowerCase().replace(/[.,;:!?]/g, '');
            const words = cleanAddr.split(/\s+/);
            
            return words.some(word => 
                ENAKIEVO_ADDRESSES.streets.some(street => street.toLowerCase().includes(word)) ||
                ENAKIEVO_ADDRESSES.districts.some(district => district.toLowerCase().includes(word)) ||
                ENAKIEVO_ADDRESSES.nearby.some(place => place.toLowerCase().includes(word))
            );
        }

        function validatePhone(phone) {
            return /^\+?[\d\s\-\(\)]{10,15}$/.test(phone.replace(/\s/g, ''));
        }

        function calculatePrice() {
            const from = document.getElementById('from').value.trim();
            const to = document.getElementById('to').value.trim();
            const phone = document.getElementById('phone').value.trim();

            // –û—á–∏—Å—Ç–∫–∞ –æ—à–∏–±–æ–∫
            document.querySelectorAll('input').forEach(el => el.classList.remove('error'));
            document.getElementById('priceCard').innerHTML = '';

            let errors = [];

            if (!from) errors.push('from');
            else if (!validateAddress(from)) {
                errors.push('from');
                document.getElementById('priceCard').innerHTML += '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∞–¥—Ä–µ—Å "–û—Ç–∫—É–¥–∞" (—É–ª. –õ–µ–Ω–∏–Ω–∞, –¶–µ–Ω—Ç—Ä, –ó—É–≥—Ä—ç—Å...)';
            }

            if (!to) errors.push('to');
            else if (!validateAddress(to)) {
                errors.push('to');
                document.getElementById('priceCard').innerHTML += '<br>‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∞–¥—Ä–µ—Å "–ö—É–¥–∞"';
            }

            if (!phone) errors.push('phone');
            else if (!validatePhone(phone)) {
                errors.push('phone');
                document.getElementById('priceCard').innerHTML += '<br>‚ùå –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞';
            }

            if (errors.length > 0) {
                errors.forEach(id => document.getElementById(id).classList.add('error'));
                document.getElementById('calcBtn').style.display = 'block';
                document.getElementById('orderBtn').style.display = 'none';
                Telegram.WebApp.MainButton.hide();
                return;
            }

            // –¢–û–ß–ù–´–ô —Ä–∞—Å—á—ë—Ç —Ü–µ–Ω—ã
            let price = 150; // –ë–∞–∑–∞ –ø–æ –ï–Ω–∞–∫–∏–µ–≤–æ
            
            const toLower = to.toLowerCase();
            if (toLower.includes('–¥–æ–Ω–µ—Ü–∫')) price += 500;
            else if (toLower.includes('–∑—É–≥—Ä—ç—Å')) price += 150;
            else if (toLower.includes('—à–∞—Ö—Ç—ë—Ä—Å–∫')) price += 250;
            else if (toLower.includes('—Ö–∞—Ä—Ü—ã–∑—Å–∫')) price += 300;
            else if (toLower.includes('–º–∞–∫–µ–µ–≤–∫–∞')) price += 400;

            price += Math.floor(Math.random() * 80) + 20; // –ù–æ—á–Ω–æ–π/—á–∞—Å –ø–∏–∫

            const time = Math.floor(Math.random() * 10) + 5;
            document.getElementById('priceCard').innerHTML = `
                üí∞ <strong>${price} ‚ÇΩ</strong><br>
                <small>‚è±Ô∏è –ü—Ä–∏–µ–∑–¥ —á–µ—Ä–µ–∑ ${time}-${time+10} –º–∏–Ω</small>
            `;

            document.getElementById('calcBtn').style.display = 'none';
            document.getElementById('orderBtn').style.display = 'block';
            Telegram.WebApp.MainButton.show();
        }

        function sendOrder() {
            const orderData = {
                from: document.getElementById('from').value.trim(),
                to: document.getElementById('to').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                comment: document.getElementById('comment').value.trim(),
                price: document.getElementById('priceCard').textContent.match(/\d+/)[0],
                time: new Date().toLocaleString('ru-RU')
            };

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
            orders.unshift(orderData);
            localStorage.setItem('orders', JSON.stringify(orders.slice(0, 50))); // –ú–∞–∫—Å 50 –∑–∞–∫–∞–∑–æ–≤
            showOrders();

            Telegram.WebApp.sendData(JSON.stringify(orderData));
            Telegram.WebApp.close();
        }

        function showOrders() {
            const list = document.getElementById('ordersList');
            document.getElementById('ordersCount').textContent = orders.length;

            if (orders.length === 0) return;

            list.innerHTML = orders.slice(0, 5).map(order => `
                <div class="order-item">
                    <div class="order-time">${order.time}</div>
                    <div class="order-route">${order.from} ‚Üí ${order.to}</div>
                    <div class="order-price">üí∞ ${order.price} ‚ÇΩ</div>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
