<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–∞–∫—Å–∏ –î–ù–†</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --bg: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --card: rgba(255, 255, 255, 0.08);
            --card-hover: rgba(255, 255, 255, 0.15);
            --accent: #22d3ee;
            --green: #4ade80;
            --red: #f87171;
            --text: #f1f5f9;
            --shadow: 0 20px 40px rgba(0,0,0,0.4);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        .container { max-width: 440px; margin: 0 auto; padding: 20px; padding-top: 80px; }
        .header { text-align: center; padding: 20px 0; }
        h1 { font-size: 38px; font-weight: 700; }
        .subtitle { opacity: 0.8; font-size: 18px; }

        #profileBtn { position: fixed; top: 20px; right: 20px; z-index: 1000; background: var(--card); backdrop-filter: blur(20px); border: none; border-radius: 50%; width: 56px; height: 56px; font-size: 30px; cursor: pointer; box-shadow: var(--shadow); transition: 0.3s; }
        #profileBtn:hover { transform: scale(1.1); }

        .card { background: var(--card); backdrop-filter: blur(20px); border-radius: 28px; padding: 32px; margin: 24px 0; box-shadow: var(--shadow); transition: 0.4s; }
        .card:hover { transform: translateY(-4px); background: var(--card-hover); }

        #map { height: 380px; border-radius: 24px; margin: 20px 0; }

        input { width: 100%; padding: 22px 20px; margin: 16px 0; background: rgba(255,255,255,0.1); border: 2px solid transparent; border-radius: 20px; font-size: 19px; color: var(--text); }
        input::placeholder { color: rgba(255,255,255,0.6); }
        input:focus { border-color: var(--accent); }

        .btn { width: 100%; padding: 24px; margin: 20px 0; border: none; border-radius: 20px; font-size: 21px; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .btn-accent { background: var(--accent); }
        .btn-green { background: var(--green); }
        .btn-red { background: var(--red); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 15px 30px rgba(34,211,238,0.3); }

        #priceCard { text-align: center; font-size: 32px; font-weight: 700; padding: 30px; min-height: 120px; display: flex; flex-direction: column; justify-content: center; }

        .order-item { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 20px; margin: 12px 0; border-left: 6px solid var(--accent); position: relative; }
        .cancel-btn { position: absolute; top: 12px; right: 12px; background: var(--red); color: white; border: none; border-radius: 12px; padding: 8px 16px; font-size: 14px; cursor: pointer; }

        #driverPanel, #passengerPanel { display: none; }
        .status-online { color: var(--green); font-size: 28px; font-weight: bold; }
        .status-offline { color: var(--red); font-size: 28px; font-weight: bold; }
    </style>
</head>
<body>
    <button id="profileBtn" onclick="openProfile()">üë§</button>

    <div id="profileModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(10px);z-index:999;justify-content:center;align-items:center;" onclick="if(event.target===this)closeProfile()">
        <div style="background:var(--card);backdrop-filter:blur(30px);border-radius:28px;padding:40px;width:90%;max-width:400px;text-align:center;box-shadow:var(--shadow);">
            <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
            <p style="font-size:24px;margin:20px 0;" id="modalName"></p>
            <p style="opacity:0.8;">ID: <span id="modalId"></span></p>
            <p style="font-size:20px;margin:20px 0;">–†–æ–ª—å: <strong id="modalRole">–ü–∞—Å—Å–∞–∂–∏—Ä</strong></p>
            <div id="driverStats" style="display:none;">
                <p>–°—Ç–∞—Ç—É—Å: <span id="onlineStatus" class="status-offline">–û—Ñ—Ñ–ª–∞–π–Ω</span></p>
                <p>–ó–∞–∫–∞–∑–æ–≤ —Å–µ–≥–æ–¥–Ω—è: <strong id="todayOrders">0</strong></p>
                <p>–ó–∞—Ä–∞–±–æ—Ç–æ–∫: <strong id="earnings">0 ‚ÇΩ</strong></p>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>–¢–∞–∫—Å–∏ –î–ù–†</h1>
            <p class="subtitle">–ï–Ω–∞–∫–∏–µ–≤–æ ‚Äî –ì–æ—Ä–ª–æ–≤–∫–∞ ‚Äî –î–æ–Ω–µ—Ü–∫</p>
        </div>

        <!-- –ü–ê–ù–ï–õ–¨ –í–û–î–ò–¢–ï–õ–Ø -->
        <div id="driverPanel">
            <div class="card">
                <h2 style="text-align:center;">–ü–∞–Ω–µ–ª—å –≤–æ–¥–∏—Ç–µ–ª—è</h2>
                <p style="text-align:center;margin:20px 0;" id="lineStatus" class="status-offline">–û—Ñ—Ñ–ª–∞–π–Ω</p>
                <button class="btn btn-green" id="lineBtn" onclick="toggleLine()">–í—ã–π—Ç–∏ –Ω–∞ –ª–∏–Ω–∏—é</button>
            </div>

            <div class="card">
                <h3 style="text-align:center;margin-bottom:20px;">–î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–∫–∞–∑—ã</h3>
                <div id="ordersForDriver">
                    <p style="text-align:center;opacity:0.6;">–ó–∞–∫–∞–∑—ã –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ –Ω–∞ –ª–∏–Ω–∏—é</p>
                </div>
            </div>
        </div>

        <!-- –ü–ê–ù–ï–õ–¨ –ü–ê–°–°–ê–ñ–ò–†–ê -->
        <div id="passengerPanel">
            <div class="card">
                <button class="btn btn-accent" onclick="locateUser()">üìç –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>
                <div id="map"></div>
                <p style="text-align:center;opacity:0.7;margin-top:16px;">–ö–ª–∏–∫: —Å–Ω–∞—á–∞–ª–∞ –û—Ç–∫—É–¥–∞ ‚Üí –ø–æ—Ç–æ–º –ö—É–¥–∞</p>
            </div>

            <div class="card">
                <input type="text" id="from" placeholder="–û—Ç–∫—É–¥–∞ (–ï–Ω–∞–∫–∏–µ–≤–æ –õ–µ–Ω–∏–Ω–∞ 15)">
                <input type="text" id="to" placeholder="–ö—É–¥–∞ (–î–æ–Ω–µ—Ü–∫ –ê—Ä—Ç—ë–º–∞ 10)">
                <input type="tel" id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω +7XXXXXXXXXX">
                <input type="text" id="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">

                <div id="priceCard" class="card">–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å–∞ –≤ –î–ù–†</div>

                <button class="btn btn-accent" onclick="calculatePrice()" id="calcBtn">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ü–µ–Ω—É</button>
                <button class="btn btn-accent" onclick="sendOrder()" id="orderBtn" style="display:none;">–ó–∞–∫–∞–∑–∞—Ç—å —Ç–∞–∫—Å–∏</button>
            </div>

            <div class="card">
                <h3 style="text-align:center;margin-bottom:20px;">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h3>
                <div id="ordersList"></div>
            </div>
        </div>
    </div>

    <script>
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        Telegram.WebApp.MainButton.setText("–ó–∞–∫–∞–∑–∞—Ç—å").hide().onClick(sendOrder);

        const user = Telegram.WebApp.initDataUnsafe.user;
        const userId = user.id;
        const fullName = user.first_name + (user.last_name ? ' ' + user.last_name : '');

        document.getElementById('modalName').textContent = fullName;
        document.getElementById('modalId').textContent = userId;

        let role = 'passenger';
        let isOnline = false;
        let orders = JSON.parse(localStorage.getItem('taxi_dnr_2gis') || '[]');

        // –¢–ï–°–¢ —Ä–æ–ª–∏ (—É–¥–∞–ª–∏ –≤ –ø—Ä–æ–¥–µ)
        if (userId % 2 === 0) role = 'driver';

        if (role === 'driver') {
            document.getElementById('driverPanel').style.display = 'block';
            document.getElementById('modalRole').textContent = '–í–æ–¥–∏—Ç–µ–ª—å üöó';
            document.getElementById('driverStats').style.display = 'block';
        } else {
            document.getElementById('passengerPanel').style.display = 'block';
            document.getElementById('modalRole').textContent = '–ü–∞—Å—Å–∞–∂–∏—Ä';
        }

        // –†–£–°–°–ö–ê–Ø –ö–ê–†–¢–ê 2GIS
        let map, fromMarker, toMarker, fromCoords, toCoords;
        let isFrom = true;

        if (role === 'passenger') {
            map = L.map('map').setView([48.23, 38.03], 12); // –¶–µ–Ω—Ç—Ä –î–ù–†

            // 2GIS —Ç–∞–π–ª—ã (—Ä—É—Å—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è, –æ—Ç–ª–∏—á–Ω–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –≤ –≥–æ—Ä–æ–¥–∞—Ö –î–ù–†)
            L.tileLayer('https://tile2.maps.2gis.com/tiles?x={x}&y={y}&z={z}&v=1', {
                maxZoom: 19,
                attribution: '¬© 2GIS'
            }).addTo(map);

            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –î–ù–† (bounding box)
            const dnrBounds = L.latLngBounds(
                L.latLng(47.5, 36.5),  // —é–≥–æ-–∑–∞–ø–∞–¥
                L.latLng(48.8, 39.0)   // —Å–µ–≤–µ—Ä–æ-–≤–æ—Å—Ç–æ–∫
            );
            map.setMaxBounds(dnrBounds);
            map.on('drag', () => { map.panInsideBounds(dnrBounds, { animate: true }); });

            map.on('click', e => {
                if (!dnrBounds.contains(e.latlng)) {
                    alert('–ê–¥—Ä–µ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –î–ù–†!');
                    return;
                }
                const latlng = e.latlng;
                if (isFrom) {
                    fromCoords = latlng;
                    if (fromMarker) fromMarker.remove();
                    fromMarker = L.marker(latlng).addTo(map).bindPopup('–û—Ç–∫—É–¥–∞').openPopup();
                    document.getElementById('from').value = `GPS –≤ –î–ù–† (${latlng.lat.toFixed(5)}, ${latlng.lng.toFixed(5)})`;
                    isFrom = false;
                } else {
                    toCoords = latlng;
                    if (toMarker) toMarker.remove();
                    toMarker = L.marker(latlng).addTo(map).bindPopup('–ö—É–¥–∞').openPopup();
                    document.getElementById('to').value = `GPS –≤ –î–ù–† (${latlng.lat.toFixed(5)}, ${latlng.lng.toFixed(5)})`;
                    isFrom = true;
                }
            });

            function locateUser() {
                Telegram.WebApp.requestLocation(pos => {
                    const latlng = { lat: pos.latitude, lng: pos.longitude };
                    if (!dnrBounds.contains(latlng)) {
                        alert('–í—ã –≤–Ω–µ –∑–æ–Ω—ã –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –î–ù–†!');
                        return;
                    }
                    map.setView(latlng, 17);
                    fromCoords = latlng;
                    if (fromMarker) fromMarker.remove();
                    fromMarker = L.marker(latlng).addTo(map).bindPopup('–í—ã –∑–¥–µ—Å—å').openPopup();
                    document.getElementById('from').value = '–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤ –î–ù–†';
                }, () => alert('–†–∞–∑—Ä–µ—à–∏—Ç–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é!'));
            }
        }

        // –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ (toggleLine, calculatePrice, sendOrder, cancelOrder, showOrders) ‚Äî –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏

        function calculatePrice() {
            // –î–æ–±–∞–≤—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –î–ù–† –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
            if (fromCoords && !dnrBounds.contains(fromCoords)) return alert('–û—Ç–∫—É–¥–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ –î–ù–†!');
            if (toCoords && !dnrBounds.contains(toCoords)) return alert('–ö—É–¥–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ –î–ù–†!');

            // ... —Ä–∞—Å—á—ë—Ç —Ü–µ–Ω—ã ...
        }

        // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ...

        if (role === 'passenger') showOrders();
    </script>
</body>
</html>
