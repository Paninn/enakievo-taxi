<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–∞–∫—Å–∏ –î–ù–† üöï</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, push, update, remove, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBrZRRocRp1FDemAZ1hLr0l5AlQGan9r5k",
            authDomain: "taxi-76c4e.firebaseapp.com",
            databaseURL: "https://taxi-76c4e-default-rtdb.firebaseio.com",
            projectId: "taxi-76c4e",
            storageBucket: "taxi-76c4e.firebasestorage.app",
            messagingSenderId: "785956414318",
            appId: "1:785956414318:web:3c14473e88c62dc868d77f",
            measurementId: "G-XX3QGHKR0S"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        window.db = db;
    </script>

    <style>
        :root {
            --bg: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --card: rgba(255, 255, 255, 0.1);
            --text: #f1f5f9;
            --text-secondary: rgba(255, 255, 255, 0.75);
            --accent: #22d3ee;
            --green: #4ade80;
            --red: #f87171;
            --purple: #c084fc;
            --shadow: 0 16px 32px rgba(0,0,0,0.4);
            --input-bg: rgba(255,255,255,0.08);
        }

        body.light-theme {
            --bg: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            --card: rgba(255, 255, 255, 0.95);
            --text: #1e293b;
            --text-secondary: rgba(30, 41, 59, 0.75);
            --accent: #0891b2;
            --green: #22c55e;
            --red: #ef4444;
            --purple: #9333ea;
            --shadow: 0 16px 32px rgba(0,0,0,0.1);
            --input-bg: rgba(0,0,0,0.05);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 90px;
            transition: all 0.5s ease;
        }

        #loader {
            position: fixed; inset: 0; background: var(--bg); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.8s ease;
        }

        .loader-title { font-size: 42px; font-weight: 800; margin-bottom: 40px; }
        .loader-track {
            position: relative;
            width: 320px;
            height: 10px;
            background: rgba(255,255,255,0.15);
            border-radius: 5px;
            overflow: hidden;
        }
        .loader-bar {
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, var(--accent), #06b6d4);
            transform: scaleX(0);
            transform-origin: left;
            animation: growBar 3.2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        .taxi {
            position: absolute;
            top: -42px;
            left: -60px;
            font-size: 52px;
            animation: driveTaxi 3.2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes growBar { to { transform: scaleX(1); } }
        @keyframes driveTaxi {
            0%   { left: -60px; }
            92%  { left: calc(100% - 50px); }
            100% { left: calc(100% - 30px); }
        }

        .container { max-width: 960px; margin: 0 auto; padding: 12px; opacity: 0; transition: opacity 1s ease; }
        .container.visible { opacity: 1; }

        .header { text-align: center; padding: 28px 0 20px; }
        h1 { font-size: 38px; font-weight: 800; }
        .subtitle { font-size: 17px; opacity: 0.9; }

        .card {
            background: var(--card);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        #map { height: 440px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); margin-bottom: 16px; cursor: pointer; }

        input, textarea {
            width: 100%; padding: 16px 18px; margin: 10px 0;
            background: var(--input-bg); border: 2px solid transparent;
            border-radius: 18px; font-size: 17px; color: var(--text);
            resize: none;
        }
        input:focus, textarea:focus { border-color: var(--accent); outline: none; }

        .address-input-wrapper { position: relative; }

        .clear-btn {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0 4px;
            display: none;
        }
        .clear-btn.visible { display: block; }

        .btn {
            width: 100%; padding: 16px; margin: 12px 0;
            border: none; border-radius: 18px; font-size: 18px; font-weight: 700;
            cursor: pointer; box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn:hover:not(:disabled) { transform: translateY(-2px); }

        .btn-accent  { background: linear-gradient(135deg, var(--accent), #06b6d4); color: white; }
        .btn-green   { background: linear-gradient(135deg, var(--green), #16a34a); color: white; }
        .btn-red     { background: linear-gradient(135deg, var(--red), #dc2626); color: white; }
        .btn-purple  { background: linear-gradient(135deg, var(--purple), #7c3aed); color: white; }

        .order-item {
            background: rgba(255,255,255,0.08);
            padding: 18px; border-radius: 18px; margin: 12px 0;
            border-left: 4px solid var(--accent);
            position: relative;
        }

        .accept-btn, .complete-btn {
            position: absolute; top: 12px; right: 12px;
            background: var(--green); color: white; border: none;
            border-radius: 12px; padding: 8px 16px; font-size: 14px; cursor: pointer;
        }
        .complete-btn { background: var(--purple); }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--card); backdrop-filter: blur(20px);
            display: flex; justify-content: space-around; padding: 10px 0;
            box-shadow: 0 -8px 25px rgba(0,0,0,0.25);
            z-index: 1000;
        }
        .nav-item {
            text-align: center; color: var(--text-secondary); font-size: 13px; cursor: pointer;
            transition: all 0.25s; padding: 6px 4px;
        }
        .nav-item.active { color: var(--accent); transform: scale(1.12); }
        .nav-item span { font-size: 26px; display: block; margin-bottom: 3px; }

        .tab { display: none; }
        .tab.active { display: block; }

        .admin-panel { background: rgba(192,132,252,0.12); border-radius: 20px; padding: 20px; margin-top: 24px; }

        .shift-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            text-align: center;
            margin: 20px 0;
        }
        .shift-stats div { font-size: 32px; font-weight: 800; }

        @media (max-width: 600px) {
            #map { height: 360px; }
            .loader-track { width: 280px; }
        }
    </style>
</head>
<body class="dark-theme">

<div id="loader">
    <div class="loader-title">–¢–∞–∫—Å–∏ –î–ù–† üöï</div>
    <div class="loader-track">
        <div class="loader-bar"></div>
        <div class="taxi">üöï</div>
    </div>
    <p style="margin-top:40px;opacity:0.8;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
</div>

<div class="container" id="mainContent">

    <div class="header">
        <h1>–¢–∞–∫—Å–∏ –î–ù–† üöï</h1>
        <p class="subtitle">–ë—ã—Å—Ç—Ä–æ ‚Ä¢ –ù–∞–¥—ë–∂–Ω–æ ‚Ä¢ –ü–æ —Ä–µ—Å–ø—É–±–ª–∏–∫–µ</p>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ –ó–∞–∫–∞–∑ -->
    <div id="tab-order" class="tab active">
        <div class="card">
            <div id="map"></div>
            <p style="text-align:center; margin-top:12px; opacity:0.8;">
                –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –≤—Ä—É—á–Ω—É—é
            </p>
        </div>

        <div class="card">
            <div class="address-input-wrapper">
                <input type="text" id="fromAddress" placeholder="üö© –û—Ç–∫—É–¥–∞">
            </div>
            <div class="address-input-wrapper">
                <input type="text" id="toAddress" placeholder="üéØ –ö—É–¥–∞">
            </div>
            <input type="tel" id="phone" placeholder="üì± –í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
            <textarea id="comment" rows="2" placeholder="üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π / –ø–æ–∂–µ–ª–∞–Ω–∏—è"></textarea>

            <div id="priceCard" class="card" style="font-size:32px; font-weight:800; text-align:center; padding:28px;">
                –í—ã–±–µ—Ä–∏—Ç–µ –æ–±–µ —Ç–æ—á–∫–∏ (–∫–∞—Ä—Ç–∞ –∏–ª–∏ –∞–¥—Ä–µ—Å)
            </div>

            <button class="btn btn-accent" id="calcBtn" disabled>–†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å</button>
            <button class="btn btn-green" onclick="sendOrder()" id="orderBtn" style="display:none;">–ó–∞–∫–∞–∑–∞—Ç—å —Ç–∞–∫—Å–∏ üöÄ</button>
        </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ –í–æ–¥–∏—Ç–µ–ª—å -->
    <div id="tab-driver" class="tab" style="display:none;">
        <div class="card">
            <div id="driverStatus" style="font-size:36px; font-weight:800; text-align:center; margin:20px 0;">
                –û—Ñ—Ñ–ª–∞–π–Ω
            </div>
            <button class="btn" id="lineBtn" onclick="toggleOnline()">–í—ã–π—Ç–∏ –Ω–∞ –ª–∏–Ω–∏—é</button>
        </div>

        <div class="card" id="driverSessionCard" style="display:none;">
            <h3 style="text-align:center; margin-bottom:20px;">–¢–µ–∫—É—â–∞—è —Å–º–µ–Ω–∞</h3>
            <div class="shift-stats">
                <div><div id="sessionEarnings">0 ‚ÇΩ</div><div style="font-size:15px; opacity:0.75;">–ó–∞—Ä–∞–±–æ—Ç–æ–∫</div></div>
                <div><div id="sessionTrips">0</div><div style="font-size:15px; opacity:0.75;">–ü–æ–µ–∑–¥–æ–∫</div></div>
            </div>
            <div id="sessionTimeInfo" style="text-align:center; margin:12px 0; opacity:0.8;">
                –í—Ä–µ–º—è –Ω–∞ –ª–∏–Ω–∏–∏: 00:00
            </div>
            <button class="btn btn-purple" id="endShiftBtn" style="display:none;" onclick="endShift()">
                –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–º–µ–Ω—É
            </button>
        </div>

        <div class="card">
            <h3 style="text-align:center; margin-bottom:16px;">–ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã</h3>
            <div id="driverOrdersList">
                <p style="text-align:center; opacity:0.6;">–ó–∞–∫–∞–∑—ã –ø–æ—è–≤—è—Ç—Å—è –∫–æ–≥–¥–∞ –≤—ã –æ–Ω–ª–∞–π–Ω</p>
            </div>
        </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ –ü–æ–µ–∑–¥–∫–∏ -->
    <div id="tab-orders" class="tab">
        <div class="card">
            <h3 style="text-align:center; margin-bottom:18px;">–ò—Å—Ç–æ—Ä–∏—è –ø–æ–µ–∑–¥–æ–∫</h3>
            <div id="passengerOrdersList">
                <p style="text-align:center; opacity:0.6;">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</p>
            </div>
        </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ –ü—Ä–æ—Ñ–∏–ª—å -->
    <div id="tab-profile" class="tab">
        <div class="card" style="text-align:center;">
            <div style="font-size:80px; margin:20px 0;">üë§</div>
            <h2 id="profileName"></h2>
            <p>ID: <strong id="profileId"></strong></p>
            <p style="margin-top:12px;">–†–æ–ª—å: <strong id="profileRole">–ü–∞—Å—Å–∞–∂–∏—Ä</strong></p>
        </div>
    </div>

    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <div id="tab-settings" class="tab">
        <div class="card">
            <h3 style="text-align:center; margin-bottom:20px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>

            <div style="display:flex; align-items:center; justify-content:space-between; padding:16px; background:rgba(255,255,255,0.05); border-radius:16px; margin:16px 0;">
                <span>–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</span>
                <button id="themeToggleBtn" onclick="toggleTheme()">üåô</button>
            </div>

            <div id="adminPanel" class="admin-panel" style="display:none;">
                <h3 style="text-align:center; color:var(--purple);">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3>
                <input type="number" id="roleUserId" placeholder="ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" style="margin:16px 0;">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <button class="btn btn-green" onclick="setRole('driver')">–í–æ–¥–∏—Ç–µ–ª—å</button>
                    <button class="btn btn-purple" onclick="setRole('admin')">–ê–¥–º–∏–Ω</button>
                </div>
                <button class="btn btn-red" style="margin-top:16px;" onclick="setRole('passenger')">–£–±—Ä–∞—Ç—å —Ä–æ–ª—å</button>
            </div>
        </div>
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item active" data-tab="tab-order"><span>üöï</span>–ó–∞–∫–∞–∑</div>
    <div class="nav-item" data-tab="tab-driver" id="navDriver" style="display:none;"><span>üöó</span>–í–æ–¥–∏—Ç–µ–ª—å</div>
    <div class="nav-item" data-tab="tab-orders"><span>üìã</span>–ü–æ–µ–∑–¥–∫–∏</div>
    <div class="nav-item" data-tab="tab-profile"><span>üë§</span>–ü—Ä–æ—Ñ–∏–ª—å</div>
    <div class="nav-item" data-tab="tab-settings"><span>‚öôÔ∏è</span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
</div>

<script>
Telegram.WebApp.ready();
Telegram.WebApp.expand();

const user = Telegram.WebApp.initDataUnsafe.user || { id: 123456789, first_name: '–¢–µ—Å—Ç', last_name: '' };
const userId = user.id.toString();
const fullName = user.first_name + (user.last_name ? ' ' + user.last_name : '');

document.getElementById('profileName').textContent = fullName;
document.getElementById('profileId').textContent = userId;

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let map, fromMarker, toMarker, routingControl;
let fromLatLng = null;
let toLatLng = null;
let currentRole = 'passenger';
let isOnline = false;
let sessionStartTime = null;
let sessionEarnings = 0;
let sessionTrips = 0;
let sessionListener = null;
const COMMISSION_RATE = 0.15;

// ‚îÄ‚îÄ –ó–∞–≥—Ä—É–∑–∫–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.onload = () => {
    setTimeout(() => {
        document.getElementById('loader').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('mainContent').classList.add('visible');
            document.body.style.overflow = 'auto';
            initMap();
            loadRoleAndUI();
        }, 900);
    }, 3400);
};

// ‚îÄ‚îÄ –ö–∞—Ä—Ç–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initMap() {
    map = L.map('map').setView([48.0159, 37.8028], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: ''
    }).addTo(map);

    map.on('click', async e => {
        const latlng = e.latlng;
        try {
            const res = await fetch(`https://photon.komoot.io/reverse?lon=${latlng.lng}&lat=${latlng.lat}`);
            const data = await res.json();
            const props = data.features?.[0]?.properties || {};
            const addr = props.name || props.street || props.city || '–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω';

            if (!fromLatLng) {
                fromLatLng = latlng;
                document.getElementById('fromAddress').value = addr;
                fromMarker?.remove();
                fromMarker = L.marker(latlng, {icon: L.divIcon({html:'üö©', className:'from-marker', iconSize:[36,36]})})
                    .addTo(map).bindPopup('–û—Ç–∫—É–¥–∞').openPopup();
            } else {
                toLatLng = latlng;
                document.getElementById('toAddress').value = addr;
                toMarker?.remove();
                toMarker = L.marker(latlng, {icon: L.divIcon({html:'üéØ', className:'to-marker', iconSize:[36,36]})})
                    .addTo(map).bindPopup('–ö—É–¥–∞').openPopup();
                map.fitBounds([fromLatLng, toLatLng], {padding:[60,60]});
            }

            checkCanCalculate();
            Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        } catch (err) {
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–¥—Ä–µ—Å');
        }
    });
}

// ‚îÄ‚îÄ –ê–¥—Ä–µ—Å–∞ –∏ —Ä–∞—Å—á—ë—Ç ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function checkCanCalculate() {
    const fromAddr = document.getElementById('fromAddress').value.trim();
    const toAddr = document.getElementById('toAddress').value.trim();

    const ready = fromLatLng && toLatLng && fromAddr.length > 2 && toAddr.length > 2;

    document.getElementById('calcBtn').disabled = !ready;

    if (ready) {
        calculateAndShowRoute();
        document.getElementById('orderBtn').style.display = 'block';
    } else {
        document.getElementById('orderBtn').style.display = 'none';
        document.getElementById('priceCard').innerHTML = '–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–µ —Ç–æ—á–∫–∏ (–∫–∞—Ä—Ç–∞ –∏–ª–∏ –∞–¥—Ä–µ—Å)';
    }
}

async function geocodeAddress(address, isFrom = true) {
    if (!address.trim()) return;

    try {
        const query = encodeURIComponent(address + ", –î–æ–Ω–µ—Ü–∫, –î–ù–†");
        const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${query}&format=json&limit=1`);
        const data = await res.json();

        if (data.length > 0) {
            const { lat, lon } = data[0];
            const latlng = L.latLng(parseFloat(lat), parseFloat(lon));

            if (isFrom) {
                fromLatLng = latlng;
                fromMarker?.remove();
                fromMarker = L.marker(latlng, {icon: L.divIcon({html:'üö©', className:'from-marker', iconSize:[36,36]})})
                    .addTo(map).bindPopup('–û—Ç–∫—É–¥–∞').openPopup();
                map.setView(latlng, 14);
            } else {
                toLatLng = latlng;
                toMarker?.remove();
                toMarker = L.marker(latlng, {icon: L.divIcon({html:'üéØ', className:'to-marker', iconSize:[36,36]})})
                    .addTo(map).bindPopup('–ö—É–¥–∞').openPopup();
                if (fromLatLng) map.fitBounds([fromLatLng, toLatLng], {padding:[60,60]});
            }

            checkCanCalculate();
            Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        }
    } catch (e) {
        console.error(e);
    }
}

document.getElementById('fromAddress').addEventListener('input', () => {
    fromLatLng = null;
    fromMarker?.remove();
    checkCanCalculate();
});

document.getElementById('toAddress').addEventListener('input', () => {
    toLatLng = null;
    toMarker?.remove();
    checkCanCalculate();
});

document.getElementById('fromAddress').addEventListener('blur', e => geocodeAddress(e.target.value, true));
document.getElementById('toAddress').addEventListener('blur', e => geocodeAddress(e.target.value, false));

window.calculateAndShowRoute = () => {
    if (!fromLatLng || !toLatLng) return;

    const distance = map.distance(fromLatLng, toLatLng) / 1000;
    const price = Math.round(180 + distance * 38);

    document.getElementById('priceCard').innerHTML = `
        <div style="font-size:42px;">${price} ‚ÇΩ</div>
        <div style="font-size:18px; opacity:0.8; margin-top:8px;">~${distance.toFixed(1)} –∫–º</div>
    `;

    routingControl?.remove();
    routingControl = L.Routing.control({
        waypoints: [fromLatLng, toLatLng],
        createMarker: () => null,
        lineOptions: { styles: [{color: '#22d3ee', weight: 7, opacity: 0.85}] },
        router: L.Routing.osrmv1({serviceUrl: 'https://router.project-osrm.org/route/v1'})
    }).addTo(map);
};

window.sendOrder = async () => {
    const from = document.getElementById('fromAddress').value.trim();
    const to = document.getElementById('toAddress').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const comment = document.getElementById('comment').value.trim();

    if (!from || !to || !phone || !fromLatLng || !toLatLng) {
        return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫–∏');
    }

    const price = parseInt(document.getElementById('priceCard').innerText.match(/\d+/)?.[0] || '0');

    const order = {
        passengerId: userId,
        passengerName: fullName,
        fromAddress: from,
        toAddress: to,
        fromLat: fromLatLng.lat,
        fromLng: fromLatLng.lng,
        toLat: toLatLng.lat,
        toLng: toLatLng.lng,
        phone,
        comment: comment || '‚Äî',
        price,
        timestamp: Date.now(),
        status: 'new'
    };

    const newRef = push(ref(db, 'orders'));
    await set(newRef, order);

    alert('–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –û–∂–∏–¥–∞–π—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è...');
    Telegram.WebApp.HapticFeedback.notificationOccurred('success');
};

// ‚îÄ‚îÄ –í–æ–¥–∏—Ç–µ–ª—å: –æ–Ω–ª–∞–π–Ω/–æ—Ñ—Ñ–ª–∞–π–Ω, —Å–º–µ–Ω–∞, –∑–∞–∫–∞–∑—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateSessionUI() {
    const card = document.getElementById('driverSessionCard');
    card.style.display = (currentRole === 'driver' && isOnline) ? 'block' : 'none';

    document.getElementById('sessionEarnings').textContent = sessionEarnings.toLocaleString('ru-RU') + ' ‚ÇΩ';
    document.getElementById('sessionTrips').textContent = sessionTrips;

    if (sessionStartTime) {
        const diff = Date.now() - sessionStartTime;
        const h = Math.floor(diff / 3600000);
        const m = Math.floor((diff % 3600000) / 60000);
        document.getElementById('sessionTimeInfo').textContent = 
            `–í—Ä–µ–º—è –Ω–∞ –ª–∏–Ω–∏–∏: ${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
    }

    document.getElementById('endShiftBtn').style.display = isOnline ? 'block' : 'none';
}

function startSessionListener() {
    if (sessionListener) sessionListener();

    sessionListener = onValue(
        query(ref(db, 'orders'), orderByChild('driverId'), equalTo(userId)),
        snap => {
            let earned = 0, trips = 0;
            snap.forEach(c => {
                const o = c.val();
                if (o.status === 'completed' && o.acceptedAt >= sessionStartTime) {
                    earned += Math.round(o.price * (1 - COMMISSION_RATE));
                    trips++;
                }
            });
            sessionEarnings = earned;
            sessionTrips = trips;
            updateSessionUI();
        }
    );
}

async function endCurrentSession() {
    if (!sessionStartTime) return;

    sessionStartTime = null;
    sessionEarnings = 0;
    sessionTrips = 0;
    if (sessionListener) sessionListener();
    updateSessionUI();

    alert(`–°–º–µ–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n–ó–∞—Ä–∞–±–æ—Ç–æ–∫: ${sessionEarnings.toLocaleString('ru-RU')} ‚ÇΩ\n–ü–æ–µ–∑–¥–æ–∫: ${sessionTrips}`);
}

window.toggleOnline = async () => {
    if (isOnline) {
        if (confirm('–£–π—Ç–∏ —Å –ª–∏–Ω–∏–∏ –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Å–º–µ–Ω—É?')) {
            await endCurrentSession();
            await remove(ref(db, `onlineDrivers/${userId}`));
        }
    } else {
        Telegram.WebApp.requestLocation(async pos => {
            sessionStartTime = Date.now();
            await set(ref(db, `onlineDrivers/${userId}`), {
                lat: pos.latitude,
                lng: pos.longitude,
                timestamp: Date.now(),
                sessionStart: sessionStartTime,
                driverName: fullName
            });
            startSessionListener();
            updateSessionUI();
        }, () => alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏'));
    }
};

window.endShift = () => {
    if (confirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–º–µ–Ω—É —Å–µ–π—á–∞—Å?')) endCurrentSession();
};

window.acceptOrder = async orderId => {
    await update(ref(db, `orders/${orderId}`), {
        status: 'accepted',
        driverId: userId,
        driverName: fullName,
        acceptedAt: Date.now()
    });
    alert('–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç!');
};

window.completeTrip = async orderId => {
    await update(ref(db, `orders/${orderId}`), {
        status: 'completed',
        completedAt: Date.now()
    });
    alert('–ü–æ–µ–∑–¥–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
};

function updateDriverOrders(orders = {}) {
    const container = document.getElementById('driverOrdersList');
    container.innerHTML = Object.keys(orders).length === 0 
        ? '<p style="text-align:center;opacity:0.7;">–ù–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤</p>'
        : Object.entries(orders).map(([id, o]) => `
            <div class="order-item">
                <div style="font-size:13px;opacity:0.7;margin-bottom:6px;">
                    ${new Date(o.timestamp).toLocaleString('ru-RU', {dateStyle:'short', timeStyle:'short'})}
                </div>
                <div style="font-weight:600;font-size:17px;">
                    ${o.fromAddress} ‚Üí ${o.toAddress}
                </div>
                <div style="margin-top:8px;">
                    üí∞ ${o.price} ‚ÇΩ ‚Ä¢ üì± ${o.phone}
                </div>
                ${o.status === 'new' ? `<button class="accept-btn" onclick="acceptOrder('${id}')">–ü—Ä–∏–Ω—è—Ç—å</button>` : ''}
                ${o.status === 'accepted' ? `<button class="complete-btn" onclick="completeTrip('${id}')">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>` : ''}
            </div>
        `).join('');
}

// ‚îÄ‚îÄ –†–æ–ª–∏ –∏ UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadRoleAndUI() {
    onValue(ref(db, `roles/${userId}`), snap => {
        currentRole = snap.val() || 'passenger';
        document.getElementById('profileRole').textContent = 
            currentRole === 'admin' ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä üëë' :
            currentRole === 'driver' ? '–í–æ–¥–∏—Ç–µ–ª—å üöó' : '–ü–∞—Å—Å–∞–∂–∏—Ä';

        document.getElementById('adminPanel').style.display = currentRole === 'admin' ? 'block' : 'none';
        document.getElementById('navDriver').style.display = currentRole === 'driver' ? 'block' : 'none';

        if (currentRole === 'driver') loadDriverStatus();
    });
}

function loadDriverStatus() {
    onValue(ref(db, `onlineDrivers/${userId}`), snap => {
        isOnline = snap.exists();
        document.getElementById('driverStatus').textContent = isOnline ? '–û–Ω–ª–∞–π–Ω üöó' : '–û—Ñ—Ñ–ª–∞–π–Ω';
        document.getElementById('driverStatus').style.color = isOnline ? 'var(--green)' : '';
        document.getElementById('lineBtn').textContent = isOnline ? '–£–π—Ç–∏ —Å –ª–∏–Ω–∏–∏' : '–í—ã–π—Ç–∏ –Ω–∞ –ª–∏–Ω–∏—é';
        document.getElementById('lineBtn').className = isOnline ? 'btn btn-red' : 'btn btn-green';
        updateSessionUI();
    });

    onValue(query(ref(db, 'orders'), orderByChild('status'), equalTo('new')), snap => {
        if (isOnline && snap.exists()) {
            Telegram.WebApp.HapticFeedback.notificationOccurred('warning');
        }
        updateDriverOrders(snap.val() || {});
    });
}

// ‚îÄ‚îÄ –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–∫–ª–∞–¥–∫–∞–º ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', () => {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');

        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(item.dataset.tab).classList.add('active');
    });
});

// ‚îÄ‚îÄ –¢–µ–º–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const savedTheme = localStorage.getItem('taxi_theme') || 'dark';
if (savedTheme === 'light') {
    document.body.classList.add('light-theme');
    document.getElementById('themeToggleBtn').textContent = '‚òÄÔ∏è';
}

window.toggleTheme = () => {
    document.body.classList.toggle('light-theme');
    const isLight = document.body.classList.contains('light-theme');
    document.getElementById('themeToggleBtn').textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
    localStorage.setItem('taxi_theme', isLight ? 'light' : 'dark');
};

// ‚îÄ‚îÄ –ê–¥–º–∏–Ω: —Å–º–µ–Ω–∞ —Ä–æ–ª–µ–π ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.setRole = async role => {
    const id = document.getElementById('roleUserId').value.trim();
    if (!id) return alert('–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');

    if (role === 'passenger') {
        await remove(ref(db, `roles/${id}`));
    } else {
        await set(ref(db, `roles/${id}`), role);
    }
    alert('–†–æ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
};
</script>
</body>
</html>
