<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–∞–∫—Å–∏ –ï–Ω–∞–∫–∏–µ–≤–æ ‚Äî –ì–æ—Ä–ª–æ–≤–∫–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --bg: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --card: rgba(255, 255, 255, 0.08);
            --card-hover: rgba(255, 255, 255, 0.15);
            --accent: #22d3ee;
            --text: #f1f5f9;
            --shadow: 0 20px 40px rgba(0,0,0,0.4);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }
        .container { max-width: 440px; margin: 0 auto; padding: 20px; padding-top: 80px; }
        .header { text-align: center; padding: 20px 0; }
        h1 { font-size: 38px; font-weight: 700; margin-bottom: 8px; }
        .subtitle { opacity: 0.8; font-size: 18px; }

        #profileBtn {
            position: fixed; top: 20px; right: 20px; z-index: 1000;
            background: var(--card); backdrop-filter: blur(20px);
            border: none; border-radius: 50%; width: 56px; height: 56px;
            font-size: 30px; cursor: pointer; box-shadow: var(--shadow);
            transition: all 0.3s;
        }
        #profileBtn:hover { transform: scale(1.1); background: var(--card-hover); }

        .card {
            background: var(--card);
            backdrop-filter: blur(20px);
            border-radius: 28px;
            padding: 32px;
            margin: 24px 0;
            box-shadow: var(--shadow);
            transition: all 0.4s;
        }
        .card:hover { transform: translateY(-4px); background: var(--card-hover); }

        #map { height: 380px; border-radius: 24px; margin: 20px 0; }

        input {
            width: 100%; padding: 22px 20px; margin: 16px 0;
            background: rgba(255,255,255,0.1);
            border: 2px solid transparent;
            border-radius: 20px;
            font-size: 19px; color: var(--text);
            transition: all 0.3s;
        }
        input::placeholder { color: rgba(255,255,255,0.6); font-size: 18px; }
        input:focus { outline: none; border-color: var(--accent); background: rgba(255,255,255,0.15); }

        .btn {
            width: 100%; padding: 24px; margin: 20px 0;
            background: var(--accent); color: white;
            border: none; border-radius: 20px;
            font-size: 21px; font-weight: 600;
            cursor: pointer; transition: all 0.3s;
        }
        .btn:hover { background: #0ea5e9; transform: translateY(-2px); box-shadow: 0 15px 30px rgba(34,211,238,0.3); }

        #priceCard {
            text-align: center; font-size: 32px; font-weight: 700;
            padding: 30px; min-height: 120px; display: flex; flex-direction: column; justify-content: center;
        }

        .orders-list { display: grid; gap: 16px; max-height: 320px; overflow-y: auto; }
        .order-item {
            background: rgba(255,255,255,0.05); padding: 20px; border-radius: 20px;
            border-left: 5px solid var(--accent);
        }
    </style>
</head>
<body>
    <button id="profileBtn" onclick="openProfile()">üë§</button>

    <div id="profileModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); backdrop-filter:blur(10px); z-index:999; justify-content:center; align-items:center;" onclick="if(event.target===this)closeProfile()">
        <div style="background:var(--card); backdrop-filter:blur(30px); border-radius:28px; padding:40px; width:90%; max-width:400px; text-align:center; box-shadow:var(--shadow);">
            <h2 style="margin-bottom:20px;">–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</h2>
            <p style="font-size:24px; margin:15px 0;" id="modalName"></p>
            <p style="font-size:16px; opacity:0.8;">ID: <span id="modalId"></span></p>
            <p style="font-size:20px; margin:20px 0;">–ó–∞–∫–∞–∑–æ–≤: <strong id="modalOrders">0</strong></p>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>–¢–∞–∫—Å–∏ –î–ù–†</h1>
            <p class="subtitle">–ï–Ω–∞–∫–∏–µ–≤–æ ‚Äî –ì–æ—Ä–ª–æ–≤–∫–∞ –∏ –æ–∫—Ä–µ—Å—Ç–Ω–æ—Å—Ç–∏</p>
        </div>

        <div class="card">
            <button class="btn" onclick="locateUser()">üìç –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>
            <div id="map"></div>
            <p style="text-align:center; opacity:0.7; margin-top:16px;">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ: —Å–Ω–∞—á–∞–ª–∞ –û—Ç–∫—É–¥–∞ ‚Üí –ø–æ—Ç–æ–º –ö—É–¥–∞</p>
        </div>

        <div class="card">
            <input type="text" id="from" placeholder="–û—Ç–∫—É–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ï–Ω–∞–∫–∏–µ–≤–æ –õ–µ–Ω–∏–Ω–∞ 15)">
            <input type="text" id="to" placeholder="–ö—É–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ì–æ—Ä–ª–æ–≤–∫–∞ –†—É–¥–∞–∫–æ–≤–∞ 10)">
            <input type="tel" id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω +7XXXXXXXXXX">
            <input type="text" id="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–ø–æ –∂–µ–ª–∞–Ω–∏—é)">

            <div id="priceCard" class="card">–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å–∞ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ</div>

            <button class="btn" onclick="calculatePrice()" id="calcBtn">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ü–µ–Ω—É</button>
            <button class="btn" onclick="sendOrder()" id="orderBtn" style="display:none;">–ó–∞–∫–∞–∑–∞—Ç—å —Ç–∞–∫—Å–∏</button>
        </div>

        <div class="card">
            <h3 style="margin-bottom:20px; text-align:center;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã</h3>
            <div class="orders-list" id="ordersList">
                <p style="text-align:center; opacity:0.6;">–ò—Å—Ç–æ—Ä–∏—è –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–∫–∞–∑–∞</p>
            </div>
        </div>
    </div>

    <script>
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        Telegram.WebApp.MainButton.setText("–ó–∞–∫–∞–∑–∞—Ç—å").hide().onClick(sendOrder);

        const user = Telegram.WebApp.initDataUnsafe.user;
        const orders = JSON.parse(localStorage.getItem('taxi_dnr_2026') || '[]');
        document.getElementById('modalName').textContent = user.first_name + (user.last_name ? ' ' + user.last_name : '');
        document.getElementById('modalId').textContent = user.id;
        showOrders();

        // –ö–∞—Ä—Ç–∞
        const map = L.map('map').setView([48.23, 38.03], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        let fromMarker, toMarker, fromCoords, toCoords;
        let isFrom = true;

        map.on('click', e => {
            const latlng = e.latlng;
            if (isFrom) {
                fromCoords = latlng;
                if (fromMarker) fromMarker.remove();
                fromMarker = L.marker(latlng).addTo(map).bindPopup('–û—Ç–∫—É–¥–∞').openPopup();
                reverseGeocode(latlng, 'from');
                isFrom = false;
            } else {
                toCoords = latlng;
                if (toMarker) toMarker.remove();
                toMarker = L.marker(latlng).addTo(map).bindPopup('–ö—É–¥–∞').openPopup();
                reverseGeocode(latlng, 'to');
                isFrom = true;
            }
        });

        function locateUser() {
            Telegram.WebApp.requestLocation(pos => {
                const latlng = { lat: pos.latitude, lng: pos.longitude };
                map.setView(latlng, 17);
                fromCoords = latlng;
                if (fromMarker) fromMarker.remove();
                fromMarker = L.marker(latlng).addTo(map).bindPopup('–í—ã –∑–¥–µ—Å—å').openPopup();
                document.getElementById('from').value = '–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ (GPS)';
            }, () => alert('–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Telegram'));
        }

        function reverseGeocode(latlng, field) {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}&zoom=18`)
                .then(r => r.json())
                .then(data => {
                    let addr = data.display_name || `GPS: ${latlng.lat.toFixed(5)}, ${latlng.lng.toFixed(5)}`;
                    // –£–ø—Ä–æ—â–∞–µ–º: –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≥–æ—Ä–æ–¥ –∏ –∞–¥—Ä–µ—Å
                    addr = addr.replace(/, –î–æ–Ω–µ—Ü–∫–∞—è –ù–∞—Ä–æ–¥–Ω–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞.*/, '').replace(/, –†–æ—Å—Å–∏—è.*/, '');
                    document.getElementById(field).value = addr;
                });
        }

        // –ê–≤—Ç–æ–ø–æ–∏—Å–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ
        ['from', 'to'].forEach(id => {
            document.getElementById(id).addEventListener('input', function() {
                const query = this.value;
                if (query.length < 4) return;
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=ua&limit=1&bounded=1&viewbox=37.8,47.9,38.4,48.4`)
                    .then(r => r.json())
                    .then(res => {
                        if (res[0]) {
                            const latlng = { lat: res[0].lat, lng: res[0].lon };
                            map.setView(latlng, 16);
                            if (id === 'from') { fromCoords = latlng; if (fromMarker) fromMarker.remove(); fromMarker = L.marker(latlng).addTo(map); }
                            else { toCoords = latlng; if (toMarker) toMarker.remove(); toMarker = L.marker(latlng).addTo(map); }
                        }
                    });
            });
        });

        function calculatePrice() {
            const phone = document.getElementById('phone').value.trim();
            if (!phone.startsWith('+7') && !phone.startsWith('8')) {
                alert('–¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å +7');
                return;
            }

            let distance = 0;
            if (fromCoords && toCoords) {
                distance = map.distance(fromCoords, toCoords) / 1000;
            } else if (!document.getElementById('from').value || !document.getElementById('to').value) {
                alert('–£–∫–∞–∂–∏—Ç–µ –æ–±–∞ –∞–¥—Ä–µ—Å–∞');
                return;
            }

            let price = Math.round(180 + distance * 35);
            if (distance > 25) price += 400;

            document.getElementById('priceCard').innerHTML = `
                <div>üí∞ ${price} ‚ÇΩ</div>
                <div style="font-size:18px; opacity:0.8; margin-top:8px;">~${distance.toFixed(1)} –∫–º</div>
            `;
            document.getElementById('orderBtn').style.display = 'block';
            Telegram.WebApp.MainButton.show();
        }

        function sendOrder() {
            const price = document.getElementById('priceCard').innerText.match(/\d+/)[0];
            const orderData = {
                from: document.getElementById('from').value,
                to: document.getElementById('to').value,
                phone: document.getElementById('phone').value,
                comment: document.getElementById('comment').value,
                price: price,
                from_gps: fromCoords ? `${fromCoords.lat.toFixed(6)},${fromCoords.lng.toFixed(6)}` : '',
                to_gps: toCoords ? `${toCoords.lat.toFixed(6)},${toCoords.lng.toFixed(6)}` : '',
                time: new Date().toLocaleString('ru-RU')
            };

            orders.unshift(orderData);
            localStorage.setItem('taxi_dnr_2026', JSON.stringify(orders.slice(0,50)));
            showOrders();

            Telegram.WebApp.sendData(JSON.stringify(orderData));
            Telegram.WebApp.close();
        }

        function showOrders() {
            const list = document.getElementById('ordersList');
            document.getElementById('modalOrders').textContent = orders.length;
            if (orders.length === 0) return;

            list.innerHTML = orders.slice(0,5).map(o => `
                <div class="order-item">
                    <div style="font-size:15px; opacity:0.8;">${o.time}</div>
                    <div style="font-size:19px; font-weight:600; margin:8px 0;">${o.from} ‚Üí ${o.to}</div>
                    <div style="font-size:21px; color:var(--accent);">üí∞ ${o.price} ‚ÇΩ</div>
                </div>
            `).join('');
        }

        function openProfile() { document.getElementById('profileModal').style.display = 'flex'; }
        function closeProfile() { document.getElementById('profileModal').style.display = 'none'; }
    </script>
</body>
</html>
