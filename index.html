<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–∞–∫—Å–∏ –î–ù–†</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --bg: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --card: rgba(255, 255, 255, 0.09);
            --card-hover: rgba(255, 255, 255, 0.18);
            --text: #f1f5f9;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --accent: #22d3ee;
            --green: #4ade80;
            --red: #f87171;
            --purple: #c084fc;
            --shadow: 0 24px 48px rgba(0,0,0,0.5);
            --input-bg: rgba(255,255,255,0.1);
            --border-focus: #22d3ee;
        }

        body.light-theme {
            --bg: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            --card: rgba(255, 255, 255, 0.85);
            --card-hover: rgba(255, 255, 255, 0.95);
            --text: #1e293b;
            --text-secondary: rgba(30, 41, 59, 0.7);
            --accent: #0891b2;
            --green: #22c55e;
            --red: #ef4444;
            --purple: #9333ea;
            --shadow: 0 24px 48px rgba(0,0,0,0.12);
            --input-bg: rgba(15, 23, 42, 0.06);
            --border-focus: #0891b2;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            transition: all 0.6s ease;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; padding-top: 100px; }
        .header { text-align: center; padding: 40px 0; }
        h1 { font-size: 52px; font-weight: 800; letter-spacing: -2px; }
        .subtitle { font-size: 22px; opacity: 0.85; margin-top: 12px; }

        #profileBtn, #themeBtn {
            position: fixed; top: 20px; z-index: 1000;
            background: var(--card); backdrop-filter: blur(20px);
            border: none; border-radius: 50%; width: 60px; height: 60px;
            font-size: 32px; cursor: pointer; box-shadow: var(--shadow);
            transition: all 0.4s ease;
        }
        #profileBtn { right: 90px; }
        #themeBtn { right: 20px; }
        #profileBtn:hover, #themeBtn:hover { transform: scale(1.12); }

        .card {
            background: var(--card);
            backdrop-filter: blur(25px);
            border-radius: 32px;
            padding: 36px;
            box-shadow: var(--shadow);
            transition: all 0.4s ease;
        }
        .card:hover { transform: translateY(-6px); background: var(--card-hover); }

        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 32px; margin-top: 20px; }
        #map { height: 600px; border-radius: 28px; box-shadow: 0 16px 40px rgba(0,0,0,0.3); }

        input {
            width: 100%; padding: 22px 20px; margin: 16px 0;
            background: var(--input-bg); border: 2px solid transparent;
            border-radius: 24px; font-size: 19px; color: var(--text);
            transition: all 0.4s ease;
        }
        input::placeholder { color: var(--text-secondary); }
        input:focus { outline: none; border-color: var(--border-focus); transform: scale(1.01); }

        .search-results {
            max-height: 200px; overflow-y: auto; margin-top: 8px; background: rgba(255,255,255,0.1);
            border-radius: 16px; padding: 8px; display: none;
        }
        .search-result-item {
            padding: 12px; border-radius: 12px; cursor: pointer; margin: 4px 0;
            transition: background 0.3s;
        }
        .search-result-item:hover { background: rgba(255,255,255,0.2); }

        .btn {
            width: 100%; padding: 24px; margin: 20px 0;
            border: none; border-radius: 24px; font-size: 21px; font-weight: 700;
            cursor: pointer; transition: all 0.4s ease;
            box-shadow: 0 12px 24px rgba(0,0,0,0.3);
        }
        .btn-accent { background: linear-gradient(135deg, var(--accent), #06b6d4); color: white; }
        .btn-green { background: linear-gradient(135deg, var(--green), #16a34a); color: white; }
        .btn:hover { transform: translateY(-4px); }

        #priceCard {
            text-align: center; font-size: 40px; font-weight: 800;
            padding: 40px; margin: 20px 0;
            min-height: 140px; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }

        .orders-section { margin-top: 40px; }
        .order-item {
            background: rgba(255,255,255,0.06);
            padding: 24px; border-radius: 24px; margin: 16px 0;
            border-left: 6px solid var(--accent); position: relative;
        }
        body.light-theme .order-item { background: rgba(15,23,42,0.05); }

        .action-btn {
            position: absolute; top: 16px; right: 16px;
            background: rgba(255,255,255,0.2); color: white;
            border: none; border-radius: 16px; padding: 10px 18px;
            font-size: 15px; cursor: pointer;
        }

        @media (max-width: 900px) {
            .main-grid { grid-template-columns: 1fr; }
            #map { height: 400px; }
            .container { padding-top: 120px; }
            h1 { font-size: 42px; }
        }
    </style>
</head>
<body>
    <button id="profileBtn" onclick="openProfile()">üë§</button>
    <button id="themeBtn" onclick="toggleTheme()">üåô</button>

    <div id="profileModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(12px);z-index:999;justify-content:center;align-items:center;" onclick="if(event.target===this)closeProfile()">
        <div style="background:var(--card);backdrop-filter:blur(30px);border-radius:32px;padding:40px;width:90%;max-width:460px;text-align:center;box-shadow:var(--shadow);">
            <h2 style="font-size:34px;margin-bottom:24px;">–ü—Ä–æ—Ñ–∏–ª—å</h2>
            <p style="font-size:28px;margin:20px 0;" id="modalName"></p>
            <p style="opacity:0.8;font-size:19px;">ID: <span id="modalId"></span></p>
            <p style="font-size:24px;margin:28px 0;">–†–æ–ª—å: <strong id="modalRole">–ü–∞—Å—Å–∞–∂–∏—Ä</strong></p>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>–¢–∞–∫—Å–∏ –î–ù–†</h1>
            <p class="subtitle">–ï–Ω–∞–∫–∏–µ–≤–æ ‚Ä¢ –ì–æ—Ä–ª–æ–≤–∫–∞ ‚Ä¢ –î–æ–Ω–µ—Ü–∫ ‚Ä¢ –ú–∞–∫–µ–µ–≤–∫–∞</p>
        </div>

        <div id="passengerPanel">
            <div class="main-grid">
                <div class="card">
                    <button class="btn btn-accent" onclick="locateUser()" style="margin-bottom:20px;">üìç –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>
                    <div id="map"></div>
                    <p style="text-align:center;opacity:0.8;margin-top:20px;">
                        –ò–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ: —Å–Ω–∞—á–∞–ª–∞ <strong>–û—Ç–∫—É–¥–∞</strong> ‚Üí –ø–æ—Ç–æ–º <strong>–ö—É–¥–∞</strong>
                    </p>
                </div>

                <div>
                    <div class="card">
                        <div style="position:relative;">
                            <input type="text" id="from" placeholder="–û—Ç–∫—É–¥–∞ (–≤–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ)">
                            <div id="fromResults" class="search-results"></div>
                        </div>
                        <div style="position:relative;">
                            <input type="text" id="to" placeholder="–ö—É–¥–∞ (–≤–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ)">
                            <div id="toResults" class="search-results"></div>
                        </div>
                        <input type="tel" id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω: +7 (___) ___-__-__">
                        <input type="text" id="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">

                        <div id="priceCard" class="card">–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å–∞ –∏–ª–∏ –æ—Ç–º–µ—Ç—å—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ</div>

                        <button class="btn btn-accent" onclick="calculatePrice()" id="calcBtn">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ü–µ–Ω—É</button>
                        <button class="btn btn-green" onclick="sendOrder()" id="orderBtn" style="display:none;">–ó–∞–∫–∞–∑–∞—Ç—å —Ç–∞–∫—Å–∏</button>
                    </div>
                </div>
            </div>

            <div class="orders-section">
                <div class="card">
                    <h3 style="text-align:center;margin-bottom:24px;font-size:30px;">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h3>
                    <div id="passengerOrdersList">
                        <p style="text-align:center;opacity:0.6;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();

        const user = Telegram.WebApp.initDataUnsafe.user || { id: 123456, first_name: '–¢–µ—Å—Ç' };
        const userId = user.id;
        const fullName = user.first_name + (user.last_name ? ' ' + user.last_name : '');

        document.getElementById('modalName').textContent = fullName;
        document.getElementById('modalId').textContent = userId;

        const savedTheme = localStorage.getItem('taxi_theme') || 'dark';
        if (savedTheme === 'light') {
            document.body.classList.add('light-theme');
            document.getElementById('themeBtn').textContent = '‚òÄÔ∏è';
        }

        window.toggleTheme = () => {
            document.body.classList.toggle('light-theme');
            const isLight = document.body.classList.contains('light-theme');
            document.getElementById('themeBtn').textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('taxi_theme', isLight ? 'light' : 'dark');
        };

        let roles = JSON.parse(localStorage.getItem('taxi_roles') || '{}');
        let orders = JSON.parse(localStorage.getItem('taxi_orders') || '[]');
        let allOrders = JSON.parse(localStorage.getItem('taxi_all_orders') || '[]');

        let currentRole = roles[userId] || 'passenger';
        document.getElementById(`${currentRole}Panel`).style.display = 'block';

        let map, fromMarker, toMarker, fromCoords = null, toCoords = null;
        let isFrom = true;

        const serviceBounds = L.latLngBounds(L.latLng(47.5, 36.8), L.latLng(48.8, 39.0));

        if (currentRole === 'passenger') {
            map = L.map('map').setView([48.23, 38.03], 12);

            L.tileLayer('https://tile2.maps.2gis.com/tiles?x={x}&y={y}&z={z}&v=1', {
                attribution: '¬© 2GIS',
                minZoom: 8,
                maxZoom: 18
            }).addTo(map);

            // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ
            map.on('click', e => {
                const latlng = e.latlng;
                if (isFrom) {
                    fromCoords = latlng;
                    if (fromMarker) fromMarker.remove();
                    fromMarker = L.marker(latlng).addTo(map).bindPopup('üì§ –û—Ç–∫—É–¥–∞').openPopup();
                    document.getElementById('from').value = '–û—Ç–º–µ—á–µ–Ω–æ –Ω–∞ –∫–∞—Ä—Ç–µ';
                    document.getElementById('fromResults').style.display = 'none';
                    isFrom = false;
                } else {
                    toCoords = latlng;
                    if (toMarker) toMarker.remove();
                    toMarker = L.marker(latlng).addTo(map).bindPopup('üì• –ö—É–¥–∞').openPopup();
                    document.getElementById('to').value = '–û—Ç–º–µ—á–µ–Ω–æ –Ω–∞ –∫–∞—Ä—Ç–µ';
                    document.getElementById('toResults').style.display = 'none';
                    isFrom = true;
                }
            });

            window.locateUser = () => {
                Telegram.WebApp.requestLocation(pos => {
                    const latlng = L.latLng(pos.latitude, pos.longitude);
                    map.setView(latlng, 16);
                    fromCoords = latlng;
                    if (fromMarker) fromMarker.remove();
                    fromMarker = L.marker(latlng).addTo(map).bindPopup('üìç –í—ã –∑–¥–µ—Å—å').openPopup();
                    document.getElementById('from').value = '–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ';
                }, () => alert('–†–∞–∑—Ä–µ—à–∏—Ç–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é'));
            };

            // –ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞
            function searchAddress(query, fieldId, resultsId, isFromPoint) {
                if (query.length < 3) {
                    document.getElementById(resultsId).style.display = 'none';
                    return;
                }

                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=ua,ru&limit=5&bounded=1&viewbox=36.8,47.5,39.0,48.8&accept-language=ru`)
                    .then(res => res.json())
                    .then(data => {
                        const resultsDiv = document.getElementById(resultsId);
                        resultsDiv.innerHTML = '';
                        if (data.length === 0) {
                            resultsDiv.innerHTML = '<div class="search-result-item">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                        } else {
                            data.forEach(item => {
                                const div = document.createElement('div');
                                div.className = 'search-result-item';
                                div.textContent = item.display_name.split(',')[0] + ', ' + item.display_name.split(',').slice(1).join(',').trim();
                                div.onclick = () => {
                                    const latlng = L.latLng(item.lat, item.lon);
                                    if (isFromPoint) {
                                        fromCoords = latlng;
                                        if (fromMarker) fromMarker.remove();
                                        fromMarker = L.marker(latlng).addTo(map).bindPopup('üì§ –û—Ç–∫—É–¥–∞').openPopup();
                                        document.getElementById('from').value = item.display_name.split(',')[0];
                                    } else {
                                        toCoords = latlng;
                                        if (toMarker) toMarker.remove();
                                        toMarker = L.marker(latlng).addTo(map).bindPopup('üì• –ö—É–¥–∞').openPopup();
                                        document.getElementById('to').value = item.display_name.split(',')[0];
                                    }
                                    map.setView(latlng, 16);
                                    resultsDiv.style.display = 'none';
                                };
                                resultsDiv.appendChild(div);
                            });
                        }
                        resultsDiv.style.display = 'block';
                    });
            }

            document.getElementById('from').addEventListener('input', e => searchAddress(e.target.value, 'from', 'fromResults', true));
            document.getElementById('to').addEventListener('input', e => searchAddress(e.target.value, 'to', 'toResults', false));

            // –°–∫—Ä—ã—Ç–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
            document.addEventListener('click', e => {
                if (!e.target.closest('#from, #fromResults, #to, #toResults')) {
                    document.getElementById('fromResults').style.display = 'none';
                    document.getElementById('toResults').style.display = 'none';
                }
            });
        }

        function isInServiceArea(coords) {
            return serviceBounds.contains(coords);
        }

        window.calculatePrice = () => {
            if (!fromCoords || !toCoords) {
                alert('–£–∫–∞–∂–∏—Ç–µ —Ç–æ—á–∫–∏ "–û—Ç–∫—É–¥–∞" –∏ "–ö—É–¥–∞" (–Ω–∞ –∫–∞—Ä—Ç–µ –∏–ª–∏ —Ç–µ–∫—Å—Ç–æ–º)');
                return;
            }

            if (!isInServiceArea(fromCoords) || !isInServiceArea(toCoords)) {
                alert('–ò–∑–≤–∏–Ω–∏—Ç–µ, –æ–¥–Ω–∞ –∏–ª–∏ –æ–±–µ —Ç–æ—á–∫–∏ –≤–Ω–µ –∑–æ–Ω—ã –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è (–î–ù–†).');
                return;
            }

            const distance = map.distance(fromCoords, toCoords) / 1000;
            const price = Math.round(180 + distance * 35 + (distance > 25 ? 400 : 0));

            document.getElementById('priceCard').innerHTML = `
                <div>üí∞ ${price} ‚ÇΩ</div>
                <div style="font-size:22px;opacity:0.8;margin-top:16px;">~${distance.toFixed(1)} –∫–º</div>
            `;
            document.getElementById('orderBtn').style.display = 'block';
            document.getElementById('calcBtn').style.display = 'none';
        };

        window.sendOrder = () => {
            const price = document.getElementById('priceCard').textContent.match(/(\d+)\s*‚ÇΩ/)[1];
            const order = {
                userId, fullName,
                from: document.getElementById('from').value,
                to: document.getElementById('to').value,
                phone: document.getElementById('phone').value || '–ù–µ —É–∫–∞–∑–∞–Ω',
                comment: document.getElementById('comment').value || '‚Äî',
                price, time: new Date().toLocaleString('ru-RU')
            };

            orders.unshift(order);
            allOrders.unshift(order);
            localStorage.setItem('taxi_orders', JSON.stringify(orders.slice(0,50)));
            localStorage.setItem('taxi_all_orders', JSON.stringify(allOrders));

            showPassengerOrders();
            alert('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
            Telegram.WebApp.sendData(JSON.stringify({ action: 'new_order', order }));
            Telegram.WebApp.close();
        };

        function showPassengerOrders() {
            const list = document.getElementById('passengerOrdersList');
            if (orders.length === 0) {
                list.innerHTML = '<p style="text-align:center;opacity:0.6;">–ó–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç</p>';
                return;
            }
            list.innerHTML = orders.slice(0,15).map((o, i) => `
                <div class="order-item">
                    <div style="font-size:16px;opacity:0.8;">${o.time}</div>
                    <div style="font-size:22px;font-weight:600;margin:10px 0;">${o.from} ‚Üí ${o.to}</div>
                    <div style="font-size:19px;">üì± ${o.phone}</div>
                    <div style="font-size:26px;color:var(--accent);margin-top:8px;">üí∞ ${o.price} ‚ÇΩ</div>
                    ${i < 3 ? '<button class="action-btn" onclick="cancelOrder(' + i + ')">–û—Ç–º–µ–Ω–∏—Ç—å</button>' : ''}
                </div>
            `).join('');
        }

        window.cancelOrder = (i) => {
            if (confirm('–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑?')) {
                orders.splice(i, 1);
                localStorage.setItem('taxi_orders', JSON.stringify(orders));
                showPassengerOrders();
            }
        };

        window.openProfile = () => document.getElementById('profileModal').style.display = 'flex';
        window.closeProfile = () => document.getElementById('profileModal').style.display = 'none';

        if (currentRole === 'passenger') showPassengerOrders();
    </script>
</body>
</html>
