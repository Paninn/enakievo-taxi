<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–∞–∫—Å–∏ –î–ù–†</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --bg: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --card: rgba(255, 255, 255, 0.09);
            --card-hover: rgba(255, 255, 255, 0.18);
            --accent: #22d3ee;
            --green: #4ade80;
            --red: #f87171;
            --purple: #c084fc;
            --yellow: #fbbf24;
            --text: #f1f5f9;
            --shadow: 0 24px 48px rgba(0,0,0,0.5);
            --radius: 32px;
            --transition: all 0.4s ease;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        .container { max-width: 520px; margin: 0 auto; padding: 24px; padding-top: 100px; }
        .header { text-align: center; padding: 40px 0; }
        h1 { font-size: 48px; font-weight: 800; }
        .subtitle { opacity: 0.85; font-size: 22px; margin-top: 12px; }
        #profileBtn { position: fixed; top: 24px; right: 24px; z-index: 1000; background: var(--card); backdrop-filter: blur(20px); border: none; border-radius: 50%; width: 64px; height: 64px; font-size: 36px; cursor: pointer; box-shadow: var(--shadow); transition: var(--transition); }
        #profileBtn:hover { transform: scale(1.15); }
        .card { background: var(--card); backdrop-filter: blur(25px); border-radius: var(--radius); padding: 40px; margin: 32px 0; box-shadow: var(--shadow); transition: var(--transition); }
        .card:hover { transform: translateY(-8px); background: var(--card-hover); }
        #map { height: 440px; border-radius: var(--radius); margin: 32px 0; box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
        input { width: 100%; padding: 28px 24px; margin: 24px 0; background: rgba(255,255,255,0.1); border: 2px solid transparent; border-radius: var(--radius); font-size: 22px; color: var(--text); transition: var(--transition); }
        input::placeholder { color: rgba(255,255,255,0.6); font-size: 21px; }
        input:focus { border-color: var(--accent); background: rgba(255,255,255,0.15); }
        .btn { width: 100%; padding: 30px; margin: 32px 0; border: none; border-radius: var(--radius); font-size: 24px; font-weight: 700; cursor: pointer; transition: var(--transition); box-shadow: 0 16px 32px rgba(0,0,0,0.3); }
        .btn-accent { background: linear-gradient(135deg, var(--accent), #0891b2); }
        .btn-green { background: linear-gradient(135deg, var(--green), #22c55e); }
        .btn-red { background: linear-gradient(135deg, var(--red), #ef4444); }
        .btn-yellow { background: linear-gradient(135deg, var(--yellow), #f59e0b); color: #000; }
        .btn:hover { transform: translateY(-6px); box-shadow: 0 24px 48px rgba(0,0,0,0.4); }
        #priceCard { text-align: center; font-size: 40px; font-weight: 800; padding: 48px; min-height: 160px; display: flex; flex-direction: column; justify-content: center; }
        .order-item { background: rgba(255,255,255,0.06); padding: 32px; border-radius: var(--radius); margin: 24px 0; border-left: 8px solid var(--accent); position: relative; }
        .action-btn { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 20px; padding: 14px 24px; font-size: 18px; cursor: pointer; }
        .stars { font-size: 48px; text-align: center; margin: 32px 0; cursor: pointer; }
        .star { transition: 0.3s; }
        .star.selected { color: var(--yellow); }
        .chat-messages { max-height: 400px; overflow-y: auto; margin: 24px 0; display: flex; flex-direction: column; gap: 16px; }
        .message { padding: 20px; border-radius: 24px; max-width: 80%; word-wrap: break-word; }
        .message.user { background: var(--accent); align-self: flex-end; }
        .message.driver { background: rgba(255,255,255,0.1); align-self: flex-start; }
        #passengerPanel, #driverPanel, #adminPanel { display: none; }
    </style>
</head>
<body>
    <button id="profileBtn" onclick="openProfile()">üë§</button>

    <div id="profileModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(12px);z-index:999;justify-content:center;align-items:center;" onclick="if(event.target===this)closeProfile()">
        <div style="background:var(--card);backdrop-filter:blur(30px);border-radius:var(--radius);padding:48px;width:90%;max-width:440px;text-align:center;box-shadow:var(--shadow);">
            <h2 style="font-size:36px;margin-bottom:32px;">–ü—Ä–æ—Ñ–∏–ª—å</h2>
            <p style="font-size:28px;margin:24px 0;" id="modalName"></p>
            <p style="opacity:0.8;font-size:20px;">ID: <span id="modalId"></span></p>
            <p style="font-size:24px;margin:32px 0;">–†–æ–ª—å: <strong id="modalRole">–ü–∞—Å—Å–∞–∂–∏—Ä</strong></p>
            <p id="ratingDisplay" style="font-size:22px;margin:20px 0;display:none;">–í–∞—à —Ä–µ–π—Ç–∏–Ω–≥: <strong id="userRating">0</strong> ‚≠ê</p>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>–¢–∞–∫—Å–∏ –î–ù–†</h1>
            <p class="subtitle">–ï–Ω–∞–∫–∏–µ–≤–æ ‚Ä¢ –ì–æ—Ä–ª–æ–≤–∫–∞ ‚Ä¢ –î–æ–Ω–µ—Ü–∫</p>
        </div>

        <!-- –ü–ê–ù–ï–õ–¨ –ü–ê–°–°–ê–ñ–ò–†–ê -->
        <div id="passengerPanel">
            <div class="card">
                <button class="btn btn-accent" onclick="locateUser()">üìç –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>
                <div id="map"></div>
                <p style="text-align:center;opacity:0.7;margin-top:20px;">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ: —Å–Ω–∞—á–∞–ª–∞ –û—Ç–∫—É–¥–∞ ‚Üí –ø–æ—Ç–æ–º –ö—É–¥–∞</p>
            </div>

            <div class="card">
                <input type="text" id="from" placeholder="–û—Ç–∫—É–¥–∞ (–ï–Ω–∞–∫–∏–µ–≤–æ –õ–µ–Ω–∏–Ω–∞ 15)">
                <input type="text" id="to" placeholder="–ö—É–¥–∞ (–ì–æ—Ä–ª–æ–≤–∫–∞ –†—É–¥–∞–∫–æ–≤–∞ 10)">
                <input type="tel" id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω +7XXXXXXXXXX">
                <input type="text" id="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">

                <div id="priceCard" class="card">–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å–∞ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞</div>

                <button class="btn btn-accent" onclick="calculatePrice()" id="calcBtn">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ü–µ–Ω—É</button>
                <button class="btn btn-accent" onclick="sendOrder()" id="orderBtn" style="display:none;">–ó–∞–∫–∞–∑–∞—Ç—å (–Ω–∞–ª–∏—á–Ω—ã–º–∏)</button>
            </div>

            <div class="card">
                <h3 style="text-align:center;margin-bottom:32px;font-size:28px;">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h3>
                <div id="passengerOrdersList"></div>
            </div>

            <!-- –†–µ–π—Ç–∏–Ω–≥ –ø–æ—Å–ª–µ –ø–æ–µ–∑–¥–∫–∏ -->
            <div class="card" id="ratingCard" style="display:none;">
                <h3 style="text-align:center;margin-bottom:32px;">–û—Ü–µ–Ω–∏—Ç–µ –ø–æ–µ–∑–¥–∫—É ‚≠ê</h3>
                <div class="stars" id="stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                <textarea id="ratingComment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –æ—Ü–µ–Ω–∫–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" rows="3"></textarea>
                <button class="btn btn-yellow" onclick="sendRating()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É</button>
            </div>

            <!-- –ß–∞—Ç —Å –≤–æ–¥–∏—Ç–µ–ª–µ–º -->
            <div class="card" id="chatCard" style="display:none;">
                <h3 style="text-align:center;margin-bottom:32px;">–ß–∞—Ç —Å –≤–æ–¥–∏—Ç–µ–ª–µ–º</h3>
                <div class="chat-messages" id="chatMessages"></div>
                <input type="text" id="chatInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                <button class="btn btn-accent" onclick="sendChatMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>

        <!-- –ü–∞–Ω–µ–ª–∏ –≤–æ–¥–∏—Ç–µ–ª—è –∏ –∞–¥–º–∏–Ω–∞ (—Å–∫—Ä—ã—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
        <div id="driverPanel">
            <div class="card">
                <h2 style="text-align:center;font-size:36px;">–ü–∞–Ω–µ–ª—å –≤–æ–¥–∏—Ç–µ–ª—è</h2>
                <p style="text-align:center;font-size:40px;margin:48px 0;" id="driverStatus">–û—Ñ—Ñ–ª–∞–π–Ω</p>
                <button class="btn btn-green" id="lineBtn" onclick="toggleOnline()">–í—ã–π—Ç–∏ –Ω–∞ –ª–∏–Ω–∏—é</button>
            </div>
        </div>

        <div id="adminPanel">
            <div class="card">
                <h2 style="text-align:center;font-size:36px;">üëë –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
                <input type="number" id="roleUserId" placeholder="ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-top:32px;">
                    <button class="btn btn-green" onclick="setRole('driver')">–ù–∞–∑–Ω–∞—á–∏—Ç—å –≤–æ–¥–∏—Ç–µ–ª–µ–º</button>
                    <button class="btn btn-purple" onclick="setRole('admin')">–ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω–æ–º</button>
                </div>
                <button class="btn btn-red" style="margin-top:24px;" onclick="setRole('passenger')">–£–±—Ä–∞—Ç—å —Ä–æ–ª—å</button>
            </div>
        </div>
    </div>

    <script>
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        Telegram.WebApp.MainButton.setText("–ó–∞–∫–∞–∑–∞—Ç—å").hide().onClick(sendOrder);

        const user = Telegram.WebApp.initDataUnsafe.user;
        const userId = user.id;
        const fullName = user.first_name + (user.last_name ? ' ' + user.last_name : '');

        document.getElementById('modalName').textContent = fullName;
        document.getElementById('modalId').textContent = userId;

        let roles = JSON.parse(localStorage.getItem('taxi_roles') || '{}');
        let orders = JSON.parse(localStorage.getItem('taxi_orders') || '[]');
        let chatMessages = JSON.parse(localStorage.getItem('taxi_chat') || '[]');

        let currentRole = roles[userId] || 'passenger';

        document.getElementById(currentRole + 'Panel').style.display = 'block';
        document.getElementById('modalRole').textContent = currentRole === 'admin' ? 'üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : currentRole === 'driver' ? '–í–æ–¥–∏—Ç–µ–ª—å üöó' : '–ü–∞—Å—Å–∞–∂–∏—Ä';

        // –ö–∞—Ä—Ç–∞ –¥–ª—è –ø–∞—Å—Å–∞–∂–∏—Ä–∞
        let map, fromMarker, toMarker, fromCoords, toCoords;
        let isFrom = true;

        if (currentRole === 'passenger') {
            map = L.map('map').setView([48.23, 38.03], 12);
            L.tileLayer('https://tile2.maps.2gis.com/tiles?x={x}&y={y}&z={z}&v=1', {
                attribution: '¬© 2GIS'
            }).addTo(map);

            map.on('click', function(e) {
                const latlng = e.latlng;
                if (isFrom) {
                    fromCoords = latlng;
                    if (fromMarker) fromMarker.remove();
                    fromMarker = L.marker(latlng).addTo(map).bindPopup('–û—Ç–∫—É–¥–∞').openPopup();
                    document.getElementById('from').value = '–ü–æ –∫–∞—Ä—Ç–µ (–î–ù–†)';
                    isFrom = false;
                } else {
                    toCoords = latlng;
                    if (toMarker) toMarker.remove();
                    toMarker = L.marker(latlng).addTo(map).bindPopup('–ö—É–¥–∞').openPopup();
                    document.getElementById('to').value = '–ü–æ –∫–∞—Ä—Ç–µ (–î–ù–†)';
                    isFrom = true;
                }
            });

            window.locateUser = function() {
                Telegram.WebApp.requestLocation(function(pos) {
                    const latlng = { lat: pos.latitude, lng: pos.longitude };
                    map.setView(latlng, 17);
                    fromCoords = latlng;
                    if (fromMarker) fromMarker.remove();
                    fromMarker = L.marker(latlng).addTo(map).bindPopup('–í—ã –∑–¥–µ—Å—å').openPopup();
                    document.getElementById('from').value = '–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ';
                }, function() {
                    alert('–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –≤ Telegram!');
                });
            };
        }

        // –†–∞—Å—á—ë—Ç —Ü–µ–Ω—ã
        window.calculatePrice = function() {
            let distance = 10;
            if (fromCoords && toCoords) {
                distance = map.distance(fromCoords, toCoords) / 1000;
            }
            const price = Math.round(180 + distance * 35 + (distance > 25 ? 400 : 0));
            document.getElementById('priceCard').innerHTML = `
                <div>üí∞ ${price} ‚ÇΩ (–Ω–∞–ª–∏—á–Ω—ã–º–∏ –≤–æ–¥–∏—Ç–µ–ª—é)</div>
                <div style="font-size:22px;opacity:0.8;margin-top:16px;">~${distance.toFixed(1)} –∫–º</div>
            `;
            document.getElementById('orderBtn').style.display = 'block';
            Telegram.WebApp.MainButton.show();
        };

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞
        window.sendOrder = function() {
            const price = document.getElementById('priceCard').textContent.match(/\d+/)[0];
            const order = {
                action: 'new_order',
                userId: userId,
                fullName: fullName,
                from: document.getElementById('from').value,
                to: document.getElementById('to').value,
                phone: document.getElementById('phone').value,
                comment: document.getElementById('comment').value,
                price: price,
                time: new Date().toLocaleString('ru-RU')
            };
            orders.unshift(order);
            localStorage.setItem('taxi_orders', JSON.stringify(orders.slice(0,50)));
            showOrders();
            Telegram.WebApp.sendData(JSON.stringify(order));
            document.getElementById('ratingCard').style.display = 'block';
            document.getElementById('chatCard').style.display = 'block';
            Telegram.WebApp.close();
        };

        // –û—Ç–º–µ–Ω–∞ –∑–∞–∫–∞–∑–∞
        window.cancelOrder = function(index) {
            if (confirm('–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑?')) {
                const canceled = orders.splice(index, 1)[0];
                localStorage.setItem('taxi_orders', JSON.stringify(orders));
                showOrders();
                Telegram.WebApp.sendData(JSON.stringify({ action: 'cancel_order', order: canceled }));
            }
        };

        // –ü–æ–∫–∞–∑ –∑–∞–∫–∞–∑–æ–≤
        function showOrders() {
            const list = document.getElementById('passengerOrdersList');
            if (orders.length === 0) {
                list.innerHTML = '<p style="text-align:center;opacity:0.6;">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</p>';
                return;
            }
            list.innerHTML = orders.map((o, i) => `
                <div class="order-item">
                    <div style="font-size:16px;opacity:0.8;">${o.time}</div>
                    <div style="font-size:22px;font-weight:600;margin:12px 0;">${o.from} ‚Üí ${o.to}</div>
                    <div style="font-size:26px;color:var(--accent);">üí∞ ${o.price} ‚ÇΩ</div>
                    <button class="action-btn" onclick="cancelOrder(${i})">–û—Ç–º–µ–Ω–∏—Ç—å</button>
                </div>
            `).join('');
        }

        // –†–µ–π—Ç–∏–Ω–≥
        let selectedRating = 5;
        const stars = document.querySelectorAll('#stars .star');
        stars.forEach((star, i) => {
            star.addEventListener('click', () => {
                selectedRating = i + 1;
                stars.forEach((s, j) => s.classList.toggle('selected', j < selectedRating));
            });
        });

        window.sendRating = function() {
            const comment = document.getElementById('ratingComment').value;
            const ratingData = { rating: selectedRating, comment, time: new Date().toLocaleString('ru-RU') };
            Telegram.WebApp.sendData(JSON.stringify({ action: 'rating', ratingData }));
            alert('–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ü–µ–Ω–∫—É!');
            document.getElementById('ratingCard').style.display = 'none';
        };

        // –ß–∞—Ç
        window.sendChatMessage = function() {
            const msg = document.getElementById('chatInput').value.trim();
            if (!msg) return;
            chatMessages.push({ from: 'passenger', msg, time: new Date().toLocaleString('ru-RU') });
            localStorage.setItem('taxi_chat', JSON.stringify(chatMessages));
            document.getElementById('chatInput').value = '';
            showChat();
            Telegram.WebApp.sendData(JSON.stringify({ action: 'chat_message', msg }));
        };

        function showChat() {
            const list = document.getElementById('chatMessages');
            list.innerHTML = chatMessages.map(m => `
                <div class="message ${m.from}">
                    <div>${m.msg}</div>
                    <small>${m.time}</small>
                </div>
            `).join('');
            list.scrollTop = list.scrollHeight;
        }

        // –í–æ–¥–∏—Ç–µ–ª—å
        window.toggleOnline = function() {
            const btn = document.getElementById('lineBtn');
            const status = document.getElementById('driverStatus');
            if (btn.textContent === '–í—ã–π—Ç–∏ –Ω–∞ –ª–∏–Ω–∏—é') {
                btn.textContent = '–£–π—Ç–∏ —Å –ª–∏–Ω–∏–∏';
                btn.className = 'btn btn-red';
                status.textContent = '–û–Ω–ª–∞–π–Ω';
                status.style.color = '#4ade80';
                Telegram.WebApp.sendData(JSON.stringify({ action: 'driver_online', userId }));
            } else {
                btn.textContent = '–í—ã–π—Ç–∏ –Ω–∞ –ª–∏–Ω–∏—é';
                btn.className = 'btn btn-green';
                status.textContent = '–û—Ñ—Ñ–ª–∞–π–Ω';
                status.style.color = '#f87171';
                Telegram.WebApp.sendData(JSON.stringify({ action: 'driver_offline', userId }));
            }
        };

        // –ê–¥–º–∏–Ω
        window.setRole = function(newRole) {
            const targetId = document.getElementById('roleUserId').value.trim();
            if (!targetId) return alert('–í–≤–µ–¥–∏—Ç–µ ID');
            roles[targetId] = newRole;
            localStorage.setItem('taxi_roles', JSON.stringify(roles));
            Telegram.WebApp.sendData(JSON.stringify({ action: 'set_role', targetId, newRole }));
            alert(`–†–æ–ª—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∞: ${newRole}`);
        };

        // –ü—Ä–æ—Ñ–∏–ª—å
        window.openProfile = function() {
            document.getElementById('profileModal').style.display = 'flex';
        };
        window.closeProfile = function() {
            document.getElementById('profileModal').style.display = 'none';
        };

        if (currentRole === 'passenger') showOrders();
        if (currentRole === 'passenger') showChat();
    </script>
</body>
</html>
